#!/bin/bash

set -efu
 
cd ubuntu

mkdir -p {dists,pool}

url_ubuntu="rsync://archive.ubuntu.com/ubuntu"
 
updates=$(
  rsync -iaO --delete --exclude mirror --exclude trace --exclude ubuntu --exclude pool --exclude dists $url_ubuntu/. .
  
  for nm_distro in "$@"; do
    for pth_dist in dists/$nm_distro{,-{backports,security,updates}}; do
      rsync -iaO --delete --exclude 'installer-*' $url_ubuntu/$pth_dist/. $pth_dist/
    done
  done
  
  set -f; rsync -iaO \
    --include '*/' \
    $(dpkg -l 2>&- | grep ^i | awk '{print $2}' | while read -r p; do echo --include "${p}_*"; done) \
    --exclude '*' $url_ubuntu/pool/. pool/; set +f
)
 
if [[ -n "$updates" ]]; then
  exit 1
else
  exit 0
fi
